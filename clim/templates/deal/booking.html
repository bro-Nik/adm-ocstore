
<!-- Data Picker -->
<link rel="stylesheet" href="{{ url_for('static', filename='/time-picker/style.css') }}">
<script src="{{ url_for('static', filename='/time-picker/jq.schedule.js') }}"></script>
<!-- endbuild -->
<!-- Container fluid -->
<div class="container-fluid px-6 d-grid gap-3 mt-3">

  <div class="row">
    <div class="col-lg-12 col-md-12 col-12">
      <!-- Page header -->
      <div>
        <div class="d-flex align-items-center mb-2">
          <div class="col-3 me-5 mb-lg-0">
            <h3 class="mb-0">Сделки</h3>
          </div>
          <div class="ms-auto">
            <button id="event_timelineData" class="btn btn-info" >timelineData()</button>
            <button id="event_scheduleData" class="btn btn-info" >scheduleData()</button>
            <button id="save" class="btn btn-info" >Сохранить</button>
            <button id="event_resetData" class="btn btn-danger" >Сбросить</button>
            <button id="event_resetRowData" class="btn btn-danger">Удалить строки</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- row  -->
  <div class="row">
    <div class="col-xl-12 col-lg-12 col-md-12 col-12">
      <div class="card h-100">

        <div id="service_select" class="col-6">
          <select class="selectpicker" 
            data-none-selected-text="Выберите услугу" width="auto" data-style="btn-white"
            data-none-results-text=""
            name="">
            {% set var = namespace(service_time=30, service_name="") %}

            {% for service in services %}
              {% if service.service_id == service_id|int %}
                {% set var.service_time = service.time %}
                {% set var.service_name = service.name %}
              {% endif %}
            <option value="{{ service.service_id }}" data-subtext="{{ (service.time/60)|smart_int }} ч" {{ 'selected' if service.service_id == service_id }}>
              {{ service.name}}
                </option>
            {% endfor %}
          </select>
        </div>

      <div id="workers">
        {% for worker in workers %}
          <div class="worker">
            <div class="worker-name col-3" data-worker-id="{{ worker.worker_id }}">
              {{ worker.name }}
            </div>
            <div class="">
              <div class="worker-days d-flex">
                {% for day in days %}
                <span class="worker-day" data-date="{{ days[day] }}">
                    {{ day }}
                  </span>
                {% endfor %}
              </div>

              <div class="schedule-conteiner">
              </div>

            </div>
          </div>


        {% endfor %}
      </div>

      </div>
    </div>
  </div>

  <div id="schedule"></div>

</div>

<script>
  var url_this_page = '{{ url_for('booking') }}'

    $('#service_select').find('select').selectpicker();
</script>
    <!-- Latest compiled and minified JavaScript -->
    <script type="text/javascript">

    var url_worker_employments = '{{ url_for('booking_data') }}';

        function addLog(type, message) {
            var $log = $('<tr />');
            $log.append($('<th />').text(type));
            $log.append($('<td />').text(message ? JSON.stringify(message) : ''));
            $("#logs table").prepend($log);
        }
        $(function () {
            $("#logs").append('<table class="table">');
            var isDraggable = true;
            var isResizable = true;
            var $sc = $("#schedule").timeSchedule({
                startTime: "10:00", // schedule start time(HH:ii)
                endTime: "18:00",   // schedule end time(HH:ii)
                widthTime: 60 * 15,  // cell timestamp example 10 minutes
                timeLineY: 50,       // height(px)
                verticalScrollbar: 20,   // scrollbar (px)
                timeLineBorder: 1,   // border(top and bottom)
                bundleMoveWidth: 6,  // width to move all schedules to the right of the clicked time line cell
                dataWidth: 0,
                widthTimeX: 20,
                draggable: isDraggable,
                resizable: isResizable,
                resizableLeft: true,
                rows: { 
                    '0': {
                        title: 'Title Area1',
                        schedule: [
                            {
                                start: '10:00',
                                end: '13:00',
                                text: 'Text Area',
                                data: {
                                }
                            },
                        ]
                    },
                },
                onChange: function (node, data) {
                    addLog('onChange', data);
                },
                onInitRow: function (node, data) {
                    addLog('onInitRow', data);
                },
                onClick: function (node, data) {
                    addLog('onClick', data);
                },
                onAppendRow: function (node, data) {
                    addLog('onAppendRow', data);
                },
                onAppendSchedule: function (node, data) {
                    addLog('onAppendSchedule', data);
                    if (data.data.class) {
                        node.addClass(data.data.class);
                    }
                    if (data.data.image) {
                        var $img = $('<div class="photo"><img></div>');
                        $img.find('img').attr('src', data.data.image);
                        node.prepend($img);
                        node.addClass('sc_bar_photo');
                    }
                },
                onScheduleClick: function (node, time, timeline) {
                    var start = time;
                    
                  var end = $(this).timeSchedule('formatTime', $(this).timeSchedule('calcStringTime', time) + {{ var.service_time|int * 60 }});
                    $(this).timeSchedule('addSchedule', timeline, {
                        start: start,
                        end: end,
                        text: '{{ var.service_name }}',
                        data: {
                            class: 'sc_bar_insert'
                        }
                    });
                    addLog('onScheduleClick', time + ' ' + timeline);
                },
            });
            $('#event_timelineData').on('click', function () {
                addLog('timelineData', $sc.timeSchedule('timelineData'));
              console.log($sc.timeSchedule('timelineData'))
            });
            $('#event_scheduleData').on('click', function () {
                addLog('scheduleData', $sc.timeSchedule('scheduleData'));
              console.log($sc.timeSchedule('scheduleData'))
            });
            $('#event_resetData').on('click', function () {
                $sc.timeSchedule('resetData');
                addLog('resetData');
            });
            $('#event_resetRowData').on('click', function () {
                $sc.timeSchedule('resetRowData');
                addLog('resetRowData');
            });
            $('#event_setDraggable').on('click', function () {
                isDraggable = !isDraggable;
                $sc.timeSchedule('setDraggable', isDraggable);
                addLog('setDraggable', isDraggable ? 'enable' : 'disable');
            });
            $('#event_setResizable').on('click', function () {
                isResizable = !isResizable;
                $sc.timeSchedule('setResizable', isResizable);
                addLog('setResizable', isResizable ? 'enable' : 'disable');
            });
            $('.ajax-data').on('click', function () {
                $.ajax({url: '{{ url_for('booking_data') }}' + $(this).attr('data-target')})
                    .done((data) => {
                        addLog('Ajax GetData', data);
                        $sc.timeSchedule('setRows', data);
                    });
            });
            $('#clear-logs').on('click', function () {
                $('#logs .table').empty();
            });

            // my code
            $('#save').on('click', function () {
              console.log($sc.timeSchedule('scheduleData'))
              alert($sc.timeSchedule('timelineData')[0].title)
              $('body').find('.deal-info-edit-link-worker').text($sc.timeSchedule('timelineData')[0].title)
              $('body').find('.deal-info-edit-link-date').text($sc.timeSchedule('scheduleData')[0].start + ' - ' + $sc.timeSchedule('scheduleData')[0].start)
            });

            $('.worker-day').on("click", function () {
              //var $modal = $('#TimeInDayModal')
              //$modal.modal('toggle');

              var position = $(this).position()
              //$('#schedule').attr('style', 'top: "' + position.left + '";')
              //$('.schedule-conteiner').attr('style', 'top: ' + position.top + 'px;')
              $('.schedule-conteiner').addClass('show')
              var worker_id = $(this).closest('div.worker').find('.worker-name').attr('data-worker-id');
              $('.schedule-conteiner').addClass('show')
              var $conteiner = $(this).closest('div.worker').find('.schedule-conteiner');
              $conteiner.addClass('show')
              $('#schedule').appendTo($conteiner);
              var date = $(this).attr('data-date');
              url_worker_employments
              var url = url_worker_employments + 'worker_' + worker_id + '/date_' + date;
              $.ajax({url: url})
                .done((data) => {
                  addLog('Ajax GetData', data);
                  $sc.timeSchedule('setRows', data);
                });
            
            });
        });

    </script>
